<!DOCTYPE html><html lang="cn"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>第五章Dubbo启停原理解析 | 硅步千里</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">第五章Dubbo启停原理解析</h1><a id="logo" href="/.">硅步千里</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">第五章Dubbo启停原理解析</h1><div class="post-meta">Sep 23, 2019</div><a class="disqus-comment-count" data-disqus-identifier="2019/09/23/第五章Dubbo启停原理解析/" href="/2019/09/23/第五章Dubbo启停原理解析/#disqus_thread"></a><div class="post-content"><h1 id="5-1-配置解析"><a href="#5-1-配置解析" class="headerlink" title="5.1 配置解析"></a>5.1 配置解析</h1><h3 id="Dubbo框架提供的三种配置方式："><a href="#Dubbo框架提供的三种配置方式：" class="headerlink" title="Dubbo框架提供的三种配置方式："></a>Dubbo框架提供的三种配置方式：</h3><ul>
<li>XML配置</li>
<li>注解</li>
<li>属性文件<h2 id="5-1-1-基于schema设计解析"><a href="#5-1-1-基于schema设计解析" class="headerlink" title="5.1.1 基于schema设计解析"></a>5.1.1 基于schema设计解析</h2></li>
<li>dubbo-config/dubbo-config-spring/src/main/resources/下：<ul>
<li>spring.schemeas 指明约束文件路径</li>
<li>spring.handlers 指明解析类路径</li>
</ul>
</li>
</ul>
<h3 id="schema模块"><a href="#schema模块" class="headerlink" title="schema模块"></a>schema模块</h3><h2 id="5-1-2-基于XML配置原理解析"><a href="#5-1-2-基于XML配置原理解析" class="headerlink" title="5.1.2 基于XML配置原理解析"></a>5.1.2 基于XML配置原理解析</h2><h3 id="解析主要在DubboNamespaceHandler中完成"><a href="#解析主要在DubboNamespaceHandler中完成" class="headerlink" title="解析主要在DubboNamespaceHandler中完成"></a>解析主要在DubboNamespaceHandler中完成</h3><h4 id="BeanDefinationParser的解析过程"><a href="#BeanDefinationParser的解析过程" class="headerlink" title="BeanDefinationParser的解析过程"></a>BeanDefinationParser的解析过程</h4><ol>
<li>新建SpringBean定义文件，交给Spring反射创建实例</li>
<li>确保没有重复定义SpringBean定义</li>
<li>依次尝试获取XML标签配置的name和interface 作为Bean唯一id</li>
<li>如果协议标签没有指定name，则默认使用dubbo</li>
<li>检查重复bean，如果重复则生成唯一id</li>
<li>每次解析向Spring注册新的BeanDefinition，后续会追加属性<h3 id="具体的标签解析"><a href="#具体的标签解析" class="headerlink" title="具体的标签解析"></a>具体的标签解析</h3><h4 id="dubbo-service"><a href="#dubbo-service" class="headerlink" title="dubbo:service"></a><a href="dubbo:service" target="_blank" rel="noopener">dubbo:service</a></h4></li>
<li>如果<a href="dubbo:service" target="_blank" rel="noopener">dubbo:service</a>配置了class属性，那么为具体的class配置类注册Bean，并注入ref属性</li>
</ol>
<h3 id="attribute-提取逻辑"><a href="#attribute-提取逻辑" class="headerlink" title="attribute 提取逻辑"></a>attribute 提取逻辑</h3><ol>
<li>查找配置对象的get、set 和is前缀方法，如果标签属性和方法名称相同，则通过反射调用存储标签对应值</li>
<li>如果没有和get、set和is前缀方法匹配，则当作parameters参数存储，parameters是一个Map对象</li>
</ol>
<h2 id="5-1-3-基于注解配置原理解析"><a href="#5-1-3-基于注解配置原理解析" class="headerlink" title="5.1.3 基于注解配置原理解析"></a>5.1.3 基于注解配置原理解析</h2><h3 id="注解处理逻辑"><a href="#注解处理逻辑" class="headerlink" title="注解处理逻辑"></a>注解处理逻辑</h3><h4 id="按需生成Bean"><a href="#按需生成Bean" class="headerlink" title="按需生成Bean"></a>按需生成Bean</h4><ol>
<li>获取EnableDouuboConfigBindings注解所有值</li>
<li>将每个EnableDubboCongfingBinding注解包含的Bean注册到Spring容器</li>
</ol>
<h4 id="提升-Service类为Bean"><a href="#提升-Service类为Bean" class="headerlink" title="提升@Service类为Bean"></a>提升@Service类为Bean</h4><p>ServiceAnnotationBeanPostProcessor</p>
<ol>
<li>提取用户配置的扫描包名称</li>
<li>触发ServiceBean定义和注入；</li>
<li>指定扫描dubbo的注解@Service，不会扫描Spring的Service注解，设置过滤器</li>
<li>将@Service作为不同的Bean注入容器</li>
<li>对扫描的服务创建BeanDefinitionHolder，用户生成ServiceBean定义</li>
<li>注册ServiceBean定义并做数据绑定</li>
</ol>
<p>实际使用过程中，会在@Service注解的服务中注入@Reference注解，这样就可以很方便地发起远端服务调用</p>
<h4 id="为-Reference注入代理对象"><a href="#为-Reference注入代理对象" class="headerlink" title="为@Reference注入代理对象"></a>为@Reference注入代理对象</h4><ol>
<li>查找所有@Reference字段和方法</li>
<li>对字段、和方法进行反射绑定 </li>
</ol>
<h1 id="5-2-服务暴露的实现原理"><a href="#5-2-服务暴露的实现原理" class="headerlink" title="5.2 服务暴露的实现原理"></a>5.2 服务暴露的实现原理</h1><h2 id="5-2-1-配置承载初始化"><a href="#5-2-1-配置承载初始化" class="headerlink" title="5.2.1 配置承载初始化"></a>5.2.1 配置承载初始化</h2><h3 id="覆盖策略"><a href="#覆盖策略" class="headerlink" title="覆盖策略"></a>覆盖策略</h3><ol>
<li>-D 传递给JVM参数优先级最高</li>
<li>代码或XML配置优先级次高</li>
<li>配置文件优先级最低</li>
</ol>
<h3 id="provider和客户端的配置"><a href="#provider和客户端的配置" class="headerlink" title="provider和客户端的配置"></a>provider和客户端的配置</h3><ol>
<li>如果provider指定了配置，会透传到客户端</li>
<li>如果客户端也配置了相应属性，则服务端的配置会被覆盖</li>
</ol>
<h2 id="5-2-2-远程服务的暴露机制"><a href="#5-2-2-远程服务的暴露机制" class="headerlink" title="5.2.2 远程服务的暴露机制"></a>5.2.2 远程服务的暴露机制</h2><h3 id="服务暴露的两大部分"><a href="#服务暴露的两大部分" class="headerlink" title="服务暴露的两大部分"></a>服务暴露的两大部分</h3><ol>
<li>将持有的服务实例通过代理转换成Invoker</li>
<li>将Invoker通过具体的协议转换成Exporter</li>
</ol>
<h4 id="ref-gt-invoker"><a href="#ref-gt-invoker" class="headerlink" title="ref-&gt;invoker"></a>ref-&gt;invoker</h4><ol>
<li>获取配置信息到Map，用于后续构造URL</li>
<li>读取全局配置信息，会自动添加前缀</li>
<li>本地服务暴露</li>
<li>上报监控地址</li>
<li>通过动态代理转换成invoker</li>
<li>服务暴露后进行服务元数据注册</li>
<li>处理没有注册中心场景，直接暴露服务</li>
</ol>
<h3 id="注册中心的服务暴露-Registry-export"><a href="#注册中心的服务暴露-Registry-export" class="headerlink" title="注册中心的服务暴露 Registry#export"></a>注册中心的服务暴露 Registry#export</h3><ol>
<li>委托具体协议进行暴露，创建NettyServer监听端口和保存服务实例</li>
<li>创建注册中心对象，与注册中心创建TCP连接</li>
<li>注册服务元数据到注册中心</li>
<li>订阅configurators节点，监听服务动态属性变更事件</li>
<li>服务销毁收尾工作（Invoker销毁时，注销端口和map中服务实例等资源，移除已注册的元数据，去掉订阅配置监听器）</li>
</ol>
<h3 id="从Invoker构造拦截器链"><a href="#从Invoker构造拦截器链" class="headerlink" title="从Invoker构造拦截器链"></a>从Invoker构造拦截器链</h3><p>拦截器初始化时，会自动注入ProtocolListenerWrapper和ProtocolFilterWrapper</p>
<h3 id="Dubboprotocol-export"><a href="#Dubboprotocol-export" class="headerlink" title="Dubboprotocol#export"></a>Dubboprotocol#export</h3><ol>
<li>从服务分组、版本、接口和端口构造key</li>
<li>把exporter存储到单例DubboProtocol中</li>
<li>创建NettyServer，并且初始化Handler</li>
</ol>
<h2 id="5-2-3-本地服务的暴露机制"><a href="#5-2-3-本地服务的暴露机制" class="headerlink" title="5.2.3 本地服务的暴露机制"></a>5.2.3 本地服务的暴露机制</h2><ol>
<li>显式指定injvm协议进行暴露</li>
<li>调用injvmProtocol#export</li>
</ol>
<h1 id="5-3-服务消费的实现原理"><a href="#5-3-服务消费的实现原理" class="headerlink" title="5.3 服务消费的实现原理"></a>5.3 服务消费的实现原理</h1><h2 id="5-3-1-单注册中心消费原理"><a href="#5-3-1-单注册中心消费原理" class="headerlink" title="5.3.1 单注册中心消费原理"></a>5.3.1 单注册中心消费原理</h2><h3 id="invoker处理：referenceConfig-createProxy"><a href="#invoker处理：referenceConfig-createProxy" class="headerlink" title="invoker处理：referenceConfig#createProxy"></a>invoker处理：referenceConfig#createProxy</h3><ol>
<li>优先判断jvm中是否包含所需服务</li>
<li>在url追加消费者元数据信息</li>
<li>单注册中心消费，客户端启动拉取服务元数据，订阅provider、路由和配置变更</li>
<li>处理多注册中心，通过cluster进行invoker合并</li>
<li>将invoker转换成接口代理</li>
</ol>
<h3 id="通过注册中心消费：RegistryProtocol-refer"><a href="#通过注册中心消费：RegistryProtocol-refer" class="headerlink" title="通过注册中心消费：RegistryProtocol#refer"></a>通过注册中心消费：RegistryProtocol#refer</h3><p>通过注册中心消费的核心数据结构是RegistryDirectory</p>
<ol>
<li>设置注册中心协议，创建注册中心实例</li>
<li>根据配置处理多分组结果聚合</li>
<li>处理订阅数据并通过Cluster合并多个Invoker</li>
</ol>
<h3 id="RegistryProtocol-doRefer"><a href="#RegistryProtocol-doRefer" class="headerlink" title="RegistryProtocol#doRefer"></a>RegistryProtocol#doRefer</h3><ol>
<li>directory持有实际invoker和接收订阅通知</li>
<li>注册消费信息到注册中心</li>
<li>订阅服务提供者，路由和动态配置</li>
<li>通过Cluster合并invoker</li>
</ol>
<h3 id="RegistryDirectory-toInvokers"><a href="#RegistryDirectory-toInvokers" class="headerlink" title="RegistryDirectory#toInvokers"></a>RegistryDirectory#toInvokers</h3><ol>
<li>根据消费方protocol配置过滤不匹配协议</li>
<li>合并provider端配置数据</li>
<li>忽略重复推送的服务列表</li>
</ol>
<h2 id="5-3-2-多注册中心消费原理"><a href="#5-3-2-多注册中心消费原理" class="headerlink" title="5.3.2 多注册中心消费原理"></a>5.3.2 多注册中心消费原理</h2><ol>
<li>遍历注册中心invoker实例，判断是否包含provider服务</li>
</ol>
<h2 id="5-3-3-直连服务消费原理"><a href="#5-3-3-直连服务消费原理" class="headerlink" title="5.3.3 直连服务消费原理"></a>5.3.3 直连服务消费原理</h2><ol>
<li><h1 id="5-4-优雅停机原理解析"><a href="#5-4-优雅停机原理解析" class="headerlink" title="5.4 优雅停机原理解析"></a>5.4 优雅停机原理解析</h1><h3 id="优雅停机6个步骤"><a href="#优雅停机6个步骤" class="headerlink" title="优雅停机6个步骤"></a>优雅停机6个步骤</h3></li>
<li><p>收到kill 9 进程退出信号，spring触发容器销毁事件</p>
</li>
<li><p>provider 端会取消注册服务元数据信息</p>
</li>
<li><p>consumer 端会收到最新地址列表（不包含准备停机的地址）</p>
</li>
<li><p>dubbo协议会发送readonly事件报文通知consumer服务不可用（客户端收到readonly后，将服务端标记为不可用）</p>
</li>
<li><p>服务端等待已经执行的任务结束并拒绝新任务执行</p>
</li>
<li><p>TCP断开</p>
</li>
</ol>
</div><div class="tags"><a href="/tags/dubbo/">dubbo</a></div><div class="post-nav"><a class="pre" href="/2019/09/23/第三章Dubbo注册中心/">第三章Dubbo注册中心</a><a class="next" href="/2019/09/23/常见的动态代理的库及使用/">常见的动态代理的库及使用</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://yoursite.com/2019/09/23/第五章Dubbo启停原理解析/';
    this.page.identifier = '2019/09/23/第五章Dubbo启停原理解析/';
    this.page.title = '第五章Dubbo启停原理解析';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//yuriy.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//yuriy.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://yuriy.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/计算机基础/" style="font-size: 15px;">计算机基础</a> <a href="/tags/算法竞赛进阶指南/" style="font-size: 15px;">算法竞赛进阶指南</a> <a href="/tags/学习日记/" style="font-size: 15px;">学习日记</a> <a href="/tags/Java基础复习/" style="font-size: 15px;">Java基础复习</a> <a href="/tags/面试准备/" style="font-size: 15px;">面试准备</a> <a href="/tags/装逼利器/" style="font-size: 15px;">装逼利器</a> <a href="/tags/每日任务/" style="font-size: 15px;">每日任务</a> <a href="/tags/算法/" style="font-size: 15px;">-算法</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/java基础/" style="font-size: 15px;">java基础</a> <a href="/tags/算法复习/" style="font-size: 15px;">算法复习</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/学习欲望/" style="font-size: 15px;">学习欲望</a> <a href="/tags/学习计划/" style="font-size: 15px;">学习计划</a> <a href="/tags/数据库基本操作/" style="font-size: 15px;">数据库基本操作</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a> <a href="/tags/LeetCode/" style="font-size: 15px;">LeetCode</a> <a href="/tags/dubbo/" style="font-size: 15px;">-dubbo</a> <a href="/tags/spring/" style="font-size: 15px;">-spring</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/spring学习/" style="font-size: 15px;">-spring学习</a> <a href="/tags/计算机基础复习/" style="font-size: 15px;">计算机基础复习</a> <a href="/tags/工具复习/" style="font-size: 15px;">工具复习</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/10/10/acwing240/">acwing240</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/09/acwing885/">acwing885</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/08/acwing835/">acwing835</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/08/acwing831/">acwing831</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/07/acwing803/">acwing803</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/06/acwing292/">acwing292</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/06/acwing327/">acwing327</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/05/acwing797/">acwing797</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/05/acwing796/">acwing796</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/04/acwing795/">acwing795</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Letzte Kommentare</i></div><script type="text/javascript" src="//yuriy.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">硅步千里.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>